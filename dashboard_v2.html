<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Dashboard v4 (Light, Table, Charts)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 6px 18px rgba(17,24,39,.06);
      --radius:14px;

      --good:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:1400px;margin:0 auto;padding:14px}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      padding:10px 12px;box-shadow:var(--shadow);
      position:sticky;top:0;z-index:10;
    }
    .chip{display:flex;gap:8px;align-items:baseline;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:13px}
    .chip b{font-size:12px;color:var(--muted);font-weight:600}
    .chip .v{font-weight:700}
    .chip .on{color:var(--bad)}
    .chip .off{color:var(--good)}
    .spacer{flex:1}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{
      border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;
      font-size:13px;min-width:220px;
    }
    .btn{
      border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;
      font-size:13px;cursor:pointer;
    }
    .btn:hover{border-color:#cbd5e1}
    .grid{
      display:grid;grid-template-columns: 1.55fr .95fr;
      gap:12px;margin-top:12px;
    }
    .panel{
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .panel h3{
      margin:0;padding:10px 12px;border-bottom:1px solid var(--line);
      font-size:14px;display:flex;gap:10px;align-items:center;
    }
    .panel h3 .sub{color:var(--muted);font-weight:600;font-size:12px}
    .panel .body{padding:10px 12px}
    .tight{padding:0}
    .tableWrap{overflow:auto;max-height:520px}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
    thead th{
      position:sticky;top:0;z-index:3;
      background:linear-gradient(#fff,#fbfbfd);
      border-bottom:1px solid var(--line);
      padding:9px 10px;text-align:left;white-space:nowrap;
      font-size:12px;color:#374151;font-weight:700;
      cursor:pointer;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px 10px;white-space:nowrap;
      vertical-align:middle;
    }
    tbody tr:hover{background:#f8fafc}
    tbody tr.sel{outline:2px solid rgba(37,99,235,.25);background:#eff6ff}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-size:11px;font-weight:700;
    }
    .up{color:var(--good)}
    .down{color:var(--bad)}
    .wait{color:var(--warn)}
    .muted{color:var(--muted)}
    .right{display:flex;flex-direction:column;gap:12px}
    .charts{display:grid;grid-template-columns:1fr;gap:12px}
    canvas{width:100% !important;height:240px !important}
    #equityChart{height:360px !important}
    .mini{height:170px !important}
    .sectionRow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .tableWrap.small{max-height:280px}
    details{border-top:1px solid var(--line)}
    summary{padding:10px 12px;cursor:pointer;color:#374151;font-weight:700;font-size:13px}
    .log{max-height:240px;overflow:auto;padding:10px 12px;border-top:1px solid var(--line);font-family:ui-monospace, monospace;font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .kpi .pill{background:#f8fafc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="chip"><b>KillSwitch</b><span id="ks" class="v off">OFF</span></div>
      <div class="chip"><b>Equity</b><span id="eq" class="v">-</span></div>
      <div class="chip"><b>WS</b><span id="ws" class="v">-</span></div>
      <div class="chip"><b>Feed</b><span id="feed" class="v">-</span></div>
      <div class="chip"><b>Util</b><span id="util" class="v">-</span></div>
      <div class="chip"><b>Brier</b><span id="brier" class="v">-</span></div>
      <div class="chip"><b>Hit%</b><span id="hit" class="v">-</span></div>
      <div class="chip"><b>Selected</b><span id="selSym" class="v">-</span></div>
      <div class="spacer"></div>
      <div class="controls">
        <input id="search" class="input" placeholder="심볼/상태/레짐 검색 (예: BTC, LONG, chop)" />
        <button id="toggleSparks" class="btn">스파크라인: ON</button>
        <button id="clearTrades" class="btn">트레이드 테이프 비우기</button>
        <label style="font-size:12px;color:#475569;">분봉</label>
        <select id="tfSel" class="input" style="min-width:90px;">
          <option value="1">1m</option>
          <option value="5">5m</option>
          <option value="15">15m</option>
          <option value="60">1h</option>
          <option value="240">4h</option>
          <option value="1440">1d</option>
        </select>
      </div>
    </div>

    <div class="panel tight">
      <h3>시장/신호 테이블 <span class="sub">키워드 중심 · 클릭하면 우측 차트가 해당 심볼로 전환</span></h3>
      <div class="tableWrap" id="mktWrap">
        <table id="mktTable">
          <thead>
            <tr>
              <th data-k="symbol">SYM</th>
              <th data-k="price">PRICE</th>
              <th data-k="status">STATUS</th>
              <th data-k="regime">REGIME</th>
              <th data-k="action_type">ACTION</th>
              <th data-k="evp">EV%</th>
              <th data-k="confp">CONF%</th>
              <th data-k="event_p_tp">EventWin%</th>
              <th data-k="event_p_timeout">Timeout%</th>
              <th data-k="event_t_median">Tmed</th>
              <th data-k="mc_win_rate">WIN%</th>
              <th data-k="mc_cvar">CVaR</th>
              <th data-k="kelly">KELLY</th>
              <th data-k="pos_roe">ROE%</th>
              <th data-k="pos_leverage">LEV</th>
              <th data-k="pos_cap_frac">CAP%</th>
              <th data-k="pos_pnl">PNL</th>
              <th data-k="spark">TREND</th>
            </tr>
          </thead>
          <tbody id="mktBody"></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h3>포트폴리오 그래프 <span class="sub">Equity (미실현 포함 실시간)</span></h3>
      <div class="body">
        <canvas id="equityChart"></canvas>
        <div class="kpi">
          <span class="pill">Balance <span class="mono" id="balKpi">-</span></span>
          <span class="pill">Equity <span class="mono" id="eqKpi">-</span></span>
          <span class="pill">DD <span class="mono" id="ddKpi">-</span></span>
        </div>
      </div>
    </div>

    <div class="panel tight" style="margin-top:12px">
      <h3>현재 포지션 <span class="sub">실시간 수익률/방향/레버리지/진입가/현재가</span></h3>
      <div class="tableWrap small">
        <table>
          <thead>
            <tr>
              <th>SYM</th><th>SIDE</th><th>ENTRY</th><th>CUR</th><th>PNL</th><th>PNL%</th><th>LEV</th><th>CAP%</th><th>AGE(s)</th>
            </tr>
          </thead>
          <tbody id="posBody"></tbody>
        </table>
      </div>
    </div>

    <div class="panel tight" style="margin-top:12px">
      <h3>트레이드 테이프 <span class="sub">ENTER/EXIT 내역 (영구 저장된 히스토리 포함)</span></h3>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>TIME</th><th>SYM</th><th>TYPE</th><th>SIDE</th><th>PRICE</th><th>PNL</th><th>ROE%</th><th>LEV</th><th>NOTE</th>
            </tr>
          </thead>
          <tbody id="tradeBody"></tbody>
        </table>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3>운영 로그 <span class="sub">필요할 때만 펼쳐서 보기</span></h3>
      <details>
        <summary>Logs 펼치기</summary>
        <div id="logs" class="log"></div>
      </details>
    </div>
  </div>

<script>
  const wsUrl = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;
  const ws = new WebSocket(wsUrl);

  const $ = (id)=>document.getElementById(id);
  const ksEl=$('ks'), eqEl=$('eq'), wsEl=$('ws'), feedEl=$('feed'), utilEl=$('util'), brierEl=$('brier'), hitEl=$('hit');
  const selSymEl=$('selSym'), searchEl=$('search'), tfSel=$('tfSel');
  const mktBody=$('mktBody'), posBody=$('posBody'), tradeBody=$('tradeBody'), logsEl=$('logs');
  const balKpi=$('balKpi'), eqKpi=$('eqKpi'), ddKpi=$('ddKpi');

  let showSparks = true;
  $('toggleSparks').onclick=()=>{
    showSparks = !showSparks;
    $('toggleSparks').textContent = `스파크라인: ${showSparks?'ON':'OFF'}`;
    if(latestPayload && latestPayload.market) renderMarketTable(latestPayload.market);
  };

  $('clearTrades').onclick=()=>{
    tradeTape.length = 0;
    seenTradeMsg.clear();
    renderTradeTape();
  };

  // ---------- state ----------
  let selectedSym = null;
  let sortKey = 'symbol';
  let sortAsc = true;

  // history for charts
  const maxPoints = 20000;
  const equityHist = []; // {t, equity}
  const sparkHist = new Map(); // sym -> [price...]

  // trade tape
  const tradeTape = []; // {time,sym,type,side,price,pnl,roe,leverage,tag,reason,note}
  const seenTradeMsg = new Set();
  let equitySeeded = false;

  // ✅ smoother rendering
  let latestPayload = null;
  let rafScheduled = false;

  // ✅ market row cache for smooth update
  const rowCache = new Map(); // symbol -> {tr, cells[]}

  // ---------- helpers ----------
  const f2 = (x)=> (x===null || x===undefined || isNaN(x)) ? '-' : Number(x).toFixed(2);
  const clamp = (a, lo, hi)=>Math.max(lo, Math.min(hi, a));

  function isNum(x){ return x !== null && x !== undefined && !isNaN(Number(x)); }

  // ✅ smooth number update (no design change)
  function smoothSetText(el, target, fmt=(v)=>String(v), durMs=260){
    if(!isNum(target)){
      el.textContent = fmt(target);
      el.dataset.v = '';
      return;
    }
    const to = Number(target);
    const from = isNum(el.dataset.v) ? Number(el.dataset.v) : to;
    if(from === to){
      el.textContent = fmt(to);
      el.dataset.v = String(to);
      return;
    }
    const t0 = performance.now();
    const d = Math.max(80, durMs);
    const step = (t)=>{
      const p = Math.min(1, (t - t0)/d);
      const e = 1 - Math.pow(1-p, 3);
      const v = from + (to - from)*e;
      el.textContent = fmt(v);
      if(p < 1) requestAnimationFrame(step);
      else el.dataset.v = String(to);
    };
    requestAnimationFrame(step);
  }

  function normSym(s){ return (s||'').replace(':USDT',''); }
  function statusClass(status){
    if(status==='LONG') return 'up';
    if(status==='SHORT') return 'down';
    if(status==='WAIT') return 'wait';
    return 'muted';
  }

  // ✅ trade type badge (ENTER/EXIT/REBAL/SPREAD clearly visible)
  function tradeTypeBadge(type){
    if(!type) return '<span class="pill muted">-</span>';
    const t = String(type).toUpperCase();
    if(t === 'ENTER') return '<span class="pill up">ENTER</span>';
    if(t === 'EXIT') return '<span class="pill down">EXIT</span>';
    if(t === 'REBAL') return '<span class="pill">REBAL</span>';
    if(t === 'REBALANCE') return '<span class="pill">REBAL</span>';
    if(t === 'SPREAD') return '<span class="pill wait">SPREAD</span>';
    if(t === 'PYRAMID') return '<span class="pill">PYRAMID</span>';
    if(t === 'KILL') return '<span class="pill down">KILL</span>';
    return `<span class="pill muted">${t}</span>`;
  }

  // Parse log lines like: "[BTC/USDT:USDT] ENTER LONG @ 42000.00"
  function parseTradeMsg(msg){
    if(!msg) return null;
    const m = msg.match(/\\[(.+?)\\]\\s+(ENTER|EXIT|REBAL|REBALANCE|SPREAD|PYRAMID|KILL)\\s*(LONG|SHORT)?\\s*(?:@\\s*([0-9.]+))?/i);
    if(!m) return null;
    const sym = m[1];
    const type = (m[2]||'').toUpperCase();
    const side = (m[3]||'').toUpperCase();
    const price = m[4] ? Number(m[4]) : null;
    const pnlMatch = msg.match(/pnl=([-0-9.]+)/i);
    const roeMatch = msg.match(/roe=([-0-9.]+)/i);
    const pnl = pnlMatch ? Number(pnlMatch[1]) : null;
    const roe = roeMatch ? Number(roeMatch[1]) : null;
    return {sym, type, side, price, pnl, roe, note: msg};
  }

  // ---------- charts ----------
  const equityChart = new Chart($('equityChart'), {
    type:'line',
    data:{
      labels:[],
      datasets:[
        { label:'Equity', data:[], pointRadius:0, borderWidth:2, tension:.25, borderColor:'#2563eb' },
      ]
    },
    options:{
      animation:false,
      responsive:true,
      plugins:{ legend:{display:true} },
      scales:{
        x:{
          display:true,
          ticks:{ autoSkip:true, maxTicksLimit:14 }
        },
        y:{ ticks:{ callback:(v)=>v } }
      }
    }
  });

  function formatTimeLabel(ts, tfMin){
    const d = new Date(ts);
    if(tfMin >= 1440){
      return `${d.getMonth()+1}/${d.getDate()}`;
    }
    if(tfMin >= 60){
      return d.toLocaleString([], {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    }
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }

  function buildEquitySeries(){
    const tfMin = Number(tfSel.value||1);
    const bucketMs = tfMin * 60 * 1000;
    if(!equityHist.length) return {labels:[], values:[]};
    const buckets = new Map();
    equityHist.forEach(p=>{
      const b = Math.floor(p.t / bucketMs);
      buckets.set(b, p);
    });
    const sorted = Array.from(buckets.entries()).sort((a,b)=>a[0]-b[0]).map(e=>e[1]);
    return {
      labels: sorted.map(p=>formatTimeLabel(p.t, tfMin)),
      values: sorted.map(p=>p.equity),
    };
  }

  function updateEquityChart(){
    const {labels, values} = buildEquitySeries();
    equityChart.data.labels = labels;
    equityChart.data.datasets[0].data = values;
    equityChart.update('none');
  }

  function pushEquityPoint(t, equity){
    equityHist.push({t, equity});
    if(equityHist.length>maxPoints) equityHist.shift();
    updateEquityChart();
  }

  function pushSymPoint(sym, t, price){
    if(!sparkHist.has(sym)) sparkHist.set(sym, []);
    const sp = sparkHist.get(sym);
    sp.push(price);
    if(sp.length>60) sp.shift();
  }

  // tiny sparkline as inline SVG
  function sparkSvg(sym){
    if(!showSparks) return '<span class="muted">-</span>';
    const sp = sparkHist.get(sym) || [];
    if(sp.length<2) return '<span class="muted">-</span>';
    const w=86,h=20,pad=2;
    const min=Math.min(...sp), max=Math.max(...sp);
    const den = (max-min) || 1;
    const pts = sp.map((v,i)=>{
      const x = pad + (i*(w-2*pad))/(sp.length-1);
      const y = pad + (h-2*pad)*(1-(v-min)/den);
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');
    const up = sp[sp.length-1] >= sp[0];
    const stroke = up ? '#16a34a' : '#dc2626';
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" aria-label="trend">
      <polyline fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="${pts}"/>
    </svg>`;
  }

  // ---------- rendering ----------
  function renderMarketTable(rows){
    const q = (searchEl.value||'').trim().toLowerCase();

    const data = (rows||[]).map(x=>{
      const sym = normSym(x.symbol);
      const evp = (x.ev||0)*100;
      const confp = (x.conf||0)*100;
      const mc_win = (x.mc_win_rate||0)*100;
      const pos_roe = (x.pos_roe||0)*100;

      const action_type =
        x.action_type ||
        (x.meta && (x.meta.action_type || x.meta.event || x.meta.trade_event)) ||
        '-';

      return {
        raw:x,
        symbol:sym,
        price: x.price ?? null,
        status: x.status || 'WAIT',
        regime: x.regime || '-',
        action_type: action_type || '-',
        evp,
        confp,
        event_p_tp: x.event_p_tp===null||x.event_p_tp===undefined?null:Number(x.event_p_tp*100),
        event_p_timeout: x.event_p_timeout===null||x.event_p_timeout===undefined?null:Number(x.event_p_timeout*100),
        event_t_median: x.event_t_median===null||x.event_t_median===undefined?null:Number(x.event_t_median),
        mc_win_rate: mc_win,
        mc_cvar: x.mc_cvar ?? x.mc_cvar_pct ?? null,
        kelly: x.kelly ?? x.kelly_frac ?? null,
        pos_roe,
        pos_leverage: x.pos_leverage ?? null,
        pos_cap_frac: x.pos_cap_frac===null||x.pos_cap_frac===undefined?null:Number(x.pos_cap_frac*100),
        pos_pnl: x.pos_pnl ?? null,
      };
    }).filter(r=>{
      if(!q) return true;
      const hay = `${r.symbol} ${r.status} ${r.regime} ${r.action_type}`.toLowerCase();
      return hay.includes(q);
    });

    data.sort((a,b)=>{
      const va = a[sortKey], vb = b[sortKey];
      const na = (va===null||va===undefined) ? -Infinity : va;
      const nb = (vb===null||vb===undefined) ? -Infinity : vb;
      if(na<nb) return sortAsc ? -1 : 1;
      if(na>nb) return sortAsc ? 1 : -1;
      return 0;
    });

    // ✅ smooth: reuse <tr> nodes, reorder with fragment
    const frag = document.createDocumentFragment();

    data.forEach(r=>{
      let cached = rowCache.get(r.symbol);
      if(!cached){
        const tr = document.createElement('tr');
        const cells = [];
        for(let i=0;i<18;i++){
          const td = document.createElement('td');
          cells.push(td);
          tr.appendChild(td);
        }
        tr.onclick=()=>{
          selectedSym = r.symbol;
          selSymEl.textContent = selectedSym;
          renderMarketTable(rows);
        };
        cached = {tr, cells};
        rowCache.set(r.symbol, cached);
      }

      const tr = cached.tr;
      const c = cached.cells;

      if(selectedSym===r.symbol) tr.classList.add('sel');
      else tr.classList.remove('sel');

      const cls = statusClass(r.status);

      c[0].className = 'mono'; c[0].innerHTML = `<b>${r.symbol}</b>`;
      c[1].className = 'mono'; c[1].textContent = (r.price!==null?f2(r.price):'-');
      c[2].className = '';     c[2].innerHTML = `<span class="pill ${cls}">${r.status}</span>`;
      c[3].className = 'mono'; c[3].textContent = r.regime;
      c[4].className = 'mono'; c[4].textContent = r.action_type;

      c[5].className = `mono ${(r.evp>=0)?'up':'down'}`; c[5].textContent = r.evp.toFixed(2);
      c[6].className = 'mono'; c[6].textContent = r.confp.toFixed(1);

      c[7].className = 'mono'; c[7].textContent = (r.event_p_tp===null?'-':r.event_p_tp.toFixed(1));
      c[8].className = 'mono'; c[8].textContent = (r.event_p_timeout===null?'-':r.event_p_timeout.toFixed(1));
      c[9].className = 'mono'; c[9].textContent = (r.event_t_median===null?'-':r.event_t_median.toFixed(0));

      c[10].className='mono'; c[10].textContent = r.mc_win_rate.toFixed(1);
      c[11].className='mono'; c[11].textContent = (r.mc_cvar===null?'-':f2(r.mc_cvar));
      c[12].className='mono'; c[12].textContent = (r.kelly===null?'-':f2(r.kelly));

      c[13].className=`mono ${(r.pos_roe>=0)?'up':'down'}`; c[13].textContent = r.pos_roe.toFixed(2);
      c[14].className='mono'; c[14].textContent = (r.pos_leverage===null?'-':r.pos_leverage);
      c[15].className='mono'; c[15].textContent = (r.pos_cap_frac===null?'-':r.pos_cap_frac.toFixed(2));
      c[16].className=`mono ${((r.pos_pnl||0)>=0)?'up':'down'}`; c[16].textContent = (r.pos_pnl===null?'-':f2(r.pos_pnl));

      c[17].className=''; c[17].innerHTML = sparkSvg(r.symbol);

      frag.appendChild(tr);
    });

    mktBody.replaceChildren(frag);

    if(!selectedSym && data.length){
      selectedSym = data[0].symbol;
      selSymEl.textContent = selectedSym;
    }
  }

  function renderPositions(positions, marketRows){
    const bySym = new Map((marketRows||[]).map(r=>[normSym(r.symbol), r]));

    posBody.innerHTML = '';
    (positions||[]).forEach(p=>{
      const sym = normSym(p.symbol);
      const m = bySym.get(sym) || {};
      const side = p.side || m.status || '-';
      const entry = p.entry_price ?? p.entry ?? null;
      const cur = p.current ?? p.price ?? null;
      const pnl = p.pnl ?? null;

      const lev = p.leverage ?? (m.pos_leverage ?? 1.0);
      const pnlPctRaw = (entry && cur) ? ((side==='LONG' ? (cur-entry) : (entry-cur)) / entry) * 100 : null;
      const pnlPct = pnlPctRaw===null?null:(pnlPctRaw * (lev ?? 1.0));
      const cap = p.cap_frac!==undefined && p.cap_frac!==null ? Number(p.cap_frac)*100 : null;
      const age = p.age_sec ?? (p.time ? Math.max(0, (Date.now()-p.time)/1000) : null);

      const cls = (side==='LONG')?'up':(side==='SHORT')?'down':'muted';
      const pnlCls = (pnl!==null && pnl<0) ? 'down' : 'up';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono"><b>${sym}</b></td>
        <td><span class="pill ${cls}">${side}</span></td>
        <td class="mono">${entry===null?'-':f2(entry)}</td>
        <td class="mono">${cur===null?'-':f2(cur)}</td>
        <td class="mono ${pnlCls}">${pnl===null?'-':f2(pnl)}</td>
        <td class="mono ${pnlPct!==null && pnlPct<0 ? 'down':'up'}">${pnlPct===null?'-':pnlPct.toFixed(2)}</td>
        <td class="mono">${lev===null?'-':lev}</td>
        <td class="mono">${cap===null?'-':cap.toFixed(1)}</td>
        <td class="mono">${age===null?'-':Number(age).toFixed(0)}</td>
      `;
      posBody.appendChild(tr);
    });

    if(!(positions||[]).length){
      posBody.innerHTML = `<tr><td class="muted" colspan="9">열려있는 포지션 없음</td></tr>`;
    }
  }

  function renderTradeTape(){
    tradeBody.innerHTML = '';
    tradeTape.slice(-200).reverse().forEach(t=>{
      const sym = t.sym || t.symbol;

      // ✅ TYPE 확정 로직: payload 우선 → 없으면 문자열 파싱 fallback
      const findType = (txt)=>{ const m = (txt||'').match(/\\b(ENTER|EXIT|REBAL|REBALANCE|SPREAD|PYRAMID|KILL)\\b/i); return m?m[1].toUpperCase():null; };
      let ttype = (t.action_type || t.ttype || t.type || t.event || '').toString().toUpperCase();
      if(ttype === 'REBALANCE') ttype = 'REBAL';
      if(!ttype || ttype==='-'){
        ttype = findType(t.reason) || findType(t.note) || "-";
      }

      const side = (t.side || '').toUpperCase();
      const cls = (side==='LONG')?'up':(side==='SHORT')?'down':'muted';

      const findPnl = (txt)=>{ const pm = (txt||'').match(/pnl=([-0-9.]+)/i); return pm?Number(pm[1]):null; };
      const findRoe = (txt)=>{ const rm = (txt||'').match(/roe=([-0-9.]+)/i); return rm?Number(rm[1]):null; };

      let pnl = (t.pnl!==undefined)?t.pnl:null;
      let roe = (t.roe!==undefined)?t.roe:null;

      if((pnl===null || pnl===undefined)) pnl = findPnl(t.note) ?? findPnl(t.reason);
      if((roe===null || roe===undefined)) roe = findRoe(t.note) ?? findRoe(t.reason);

      if((pnl===null || pnl===undefined) && t.realized_r!==undefined && t.notional){
        try { pnl = Number(t.realized_r) * Number(t.notional); } catch(e){}
      }
      if((roe===null || roe===undefined) && t.realized_r!==undefined){
        try { roe = Number(t.realized_r); } catch(e){}
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${t.time||'-'}</td>
        <td class="mono"><b>${normSym(sym)}</b></td>
        <td>${tradeTypeBadge(ttype)}</td>
        <td><span class="pill ${cls}">${side||'-'}</span></td>
        <td class="mono">${t.price===null||t.price===undefined?'-':f2(t.price)}</td>
        <td class="mono ${(pnl!==null&&pnl<0)?'down':'up'}">${pnl===null||pnl===undefined?'-':f2(pnl)}</td>
        <td class="mono">${roe===null||roe===undefined?'-':(roe*100).toFixed(2)}</td>
        <td class="mono">${t.leverage===null||t.leverage===undefined?'-':t.leverage}</td>
        <td class="muted">${t.tag||''} ${t.reason||t.note||''}</td>
      `;
      tradeBody.appendChild(tr);
    });

    if(!tradeTape.length){
      tradeBody.innerHTML = `<tr><td class="muted" colspan="9">아직 트레이드 이벤트 없음 (logs에서 ENTER/EXIT가 찍히면 자동으로 들어옴)</td></tr>`;
    }
  }

  function updateTradeTapeFromLogs(logs){
    (logs||[]).forEach(l=>{
      const key = `${l.time}|${l.msg}`;
      if(seenTradeMsg.has(key)) return;
      const p = parseTradeMsg(l.msg);
      if(!p) return;
      seenTradeMsg.add(key);
      tradeTape.push({ time:l.time, ...p });
      if(tradeTape.length>1000) tradeTape.shift();
    });
    renderTradeTape();
  }

  function renderLogs(logs){
    logsEl.innerHTML = '';
    (logs||[]).slice(-250).forEach(l=>{
      const lvl = (l.level||'INFO').toUpperCase();
      logsEl.innerHTML += `<div>[${l.time}] <span class="muted">${lvl}</span> ${l.msg}</div>`;
    });
  }

  // Sorting
  document.querySelectorAll('#mktTable thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k;
      if(!k) return;
      if(sortKey===k) sortAsc = !sortAsc;
      else { sortKey = k; sortAsc = true; }
      if(latestPayload && latestPayload.market) renderMarketTable(latestPayload.market);
    });
  });

  searchEl.addEventListener('input', ()=>{
    if(latestPayload && latestPayload.market) renderMarketTable(latestPayload.market);
  });
  tfSel.addEventListener('change', ()=>{ updateEquityChart(); });

  function applyUpdate(d){
    if(d.type !== 'full_update') return;

    // topbar
    const ksOn = !!d.kill_switch;
    ksEl.textContent = ksOn ? 'ON' : 'OFF';
    ksEl.className = `v ${ksOn?'on':'off'}`;

    const equity = Number((d.portfolio && d.portfolio.equity) || 0);
    smoothSetText(eqEl, equity, (v)=>Number(v).toFixed(2), 260);

    wsEl.textContent = (d.engine && d.engine.ws_clients !== undefined) ? d.engine.ws_clients : '-';
    feedEl.textContent = (d.feed && d.feed.connected) ? 'OK' : 'STALE';

    const utilVal = (d.portfolio && d.portfolio.utilization!==undefined) ? d.portfolio.utilization : null;
    const utilCap = d.portfolio ? d.portfolio.utilization_cap : null;
    utilEl.textContent = utilVal===null?'-':(utilVal*100).toFixed(1)+'%'+(utilCap?`/${(utilCap*100).toFixed(0)}%`:'');

    const evalm = d.eval_metrics || {};
    brierEl.textContent = evalm.brier===null||evalm.brier===undefined?'-':evalm.brier.toFixed(4);
    hitEl.textContent = evalm.hit_rate===null||evalm.hit_rate===undefined?'-':(evalm.hit_rate*100).toFixed(1)+'%';
    selSymEl.textContent = selectedSym || '-';

    // KPIs
    const bal = Number((d.portfolio && d.portfolio.balance) || 0);
    smoothSetText(balKpi, bal, (v)=>Number(v).toFixed(2), 260);
    smoothSetText(eqKpi, equity, (v)=>Number(v).toFixed(2), 260);

    // dd
    const peak = equityHist.reduce((m,p)=>Math.max(m,p.equity), equity);
    const dd = peak>0 ? ((equity-peak)/peak)*100 : 0;
    ddKpi.textContent = `${dd.toFixed(2)}%`;

    // seed history
    if(!equitySeeded && d.portfolio && Array.isArray(d.portfolio.history) && d.portfolio.history.length){
      equityHist.length = 0;
      d.portfolio.history.forEach(p=>{
        equityHist.push({t:p.time || p.ts || Date.now(), equity:p.equity});
      });
      equitySeeded = true;
      updateEquityChart();
    }

    const t = d.server_time || Date.now();
    pushEquityPoint(t, equity);

    // market
    const rows = d.market || [];
    rows.forEach(x=>{
      const sym = normSym(x.symbol);
      const price = Number(x.price || 0);
      pushSymPoint(sym, t, price);
    });
    renderMarketTable(rows);

    // positions
    const positions = (d.portfolio && d.portfolio.positions) ? d.portfolio.positions : [];
    renderPositions(positions, rows);

    // trade tape: payload 우선 → logs fallback
    if(Array.isArray(d.trade_tape) && d.trade_tape.length){
      tradeTape.length = 0;
      d.trade_tape.slice(-500).forEach(t=> tradeTape.push(t));
      renderTradeTape();
    } else {
      updateTradeTapeFromLogs(d.logs || []);
    }

    renderLogs(d.logs || []);
  }

  ws.onmessage = (e)=>{
    try{
      latestPayload = JSON.parse(e.data);
    }catch(_){
      return;
    }
    if(!rafScheduled){
      rafScheduled = true;
      requestAnimationFrame(()=>{
        rafScheduled = false;
        applyUpdate(latestPayload);
      });
    }
  };
</script>
</body>
</html>
